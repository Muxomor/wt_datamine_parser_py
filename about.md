# Техническое задание: Комплексный парсер данных War Thunder с модулями локализации, экономических данных и мультимедиа

## Описание проекта

Модульное Python-приложение для парсинга данных игры War Thunder из различных источников и преобразования их в структурированные CSV-файлы. Приложение обрабатывает древовидную структуру техники различных стран, типов и рангов, корректно определяет зависимости между техникой, разделяет обычную и премиумную технику, создает файлы локализации с русскими названиями юнитов, извлекает экономические данные (серебро, опыт, боевой рейтинг), обрабатывает требования по рангам, собирает флаги стран и изображения техники. Включает предварительную очистку от аномальных элементов для обеспечения стабильной работы.

## Архитектура проекта

### Структура файлов (ОБНОВЛЕНО)
```
project/
├── utils.py                           # Конфигурация, логирование и константы
├── shop_parser.py                     # Основная логика парсинга shop.blkx + извлечение image полей
├── localization_parser.py             # Парсинг локализации юнитов
├── wpcost_parser.py                   # Парсинг экономических данных (серебро, опыт, БР)
├── misc_and_images_parser.py          # Парсинг требований по рангам, флагов стран и изображений
├── nodes_merger.py                    # Объединение данных и создание графа зависимостей (НОВЫЙ)
├── main.py                            # Точка входа и CLI интерфейс
├── config.txt                         # Конфигурационный файл с URL источников данных
└── README.md                          # Документация
```

### Модули приложения

#### 1. **utils.py** - Инфраструктура и настройки
**Классы:**
- **Config** - чтение и управление конфигурацией из файла
- **Logger** - настройка логирования в файл и консоль
- **Constants** - все константы приложения (пороги, маппинги, поля, URL)

**Основные константы:**
- `PREMIUM_THRESHOLD = 0.3` - порог определения премиум колонки (30%)
- `PROCESS_SLAVE_UNITS = False` - обрабатывать ли slave-юниты
- `VEHICLE_TYPE_MAPPING` - маппинг типов техники
- `COUNTRY_MAPPING` - маппинг стран
- `RANK_TYPE_MAPPING` - маппинг типов техники для требований по рангам
- `PREMIUM_INDICATORS` - признаки премиумной техники
- `ANOMALOUS_SUFFIXES` - список аномальных окончаний для удаления
- `FLAGS_BASE_URL` - базовый URL для флагов стран
- `IMAGES_BASE_URL` - базовый URL для изображений техники
- `GITHUB_API_BASE_URL` - базовый URL для GitHub API
- Поля для всех типов CSV файлов

#### 2. **shop_parser.py** - Основная бизнес-логика + извлечение изображений
**Класс ShopParser:**
- Предварительная очистка от аномальных элементов
- Загрузка данных из удаленного источника shop.blkx
- **НОВОЕ:** Извлечение полей `image` из всех элементов JSON
- Парсинг иерархической структуры техники
- Обработка master-slave пар и групп
- Определение зависимостей и координат
- Экспорт результатов в CSV
- **НОВОЕ:** Создание файла `shop_images_fields.csv` с fallback данными для изображений

**Ключевые методы:**
- `fetch_shop_data()` - загрузка данных shop.blkx
- `has_anomalous_suffix()` - проверка на аномальные окончания
- `clean_anomalous_elements()` - предварительная очистка данных
- **НОВОЕ:** `extract_all_image_fields()` - извлечение всех полей image из JSON
- **НОВОЕ:** `_extract_image_field()` - извлечение поля image для одного элемента
- `collect_master_slave_pairs()` - предварительный сбор пар
- `parse_shop_data()` - основной парсинг с очисткой и извлечением image полей
- `process_country_data()` - обработка данных страны
- `save_to_csv()` - экспорт основных данных в shop.csv
- **НОВОЕ:** `save_image_fields_to_csv()` - экспорт полей image в shop_images_fields.csv

#### 3. **localization_parser.py** - Парсинг локализации
**Класс LocalizationParser:**
- Загрузка данных локализации из удаленного источника CSV
- Парсинг CSV файла локализации с приоритетной системой
- Сопоставление ID юнитов с русскими названиями
- Обработка различных типов записей (shop, группы, числовые суффиксы)
- Экспорт маппинга локализации в CSV

**Ключевые методы:**
- `fetch_localization_data()` - загрузка CSV локализации
- `parse_localization_csv()` - парсинг с приоритетами
- `load_shop_ids()` - загрузка ID из shop.csv
- `create_localization_mapping()` - создание маппинга ID → название
- `_find_localization_for_id()` - умный поиск локализации
- `save_to_csv()` - экспорт локализации

#### 4. **wpcost_parser.py** - Парсинг экономических данных
**Класс WpcostParser:**
- Загрузка данных wpcost.blkx из удаленного источника с поддержкой fallback URL
- Извлечение экономических параметров (серебро, опыт, боевой рейтинг)
- Вычисление боевого рейтинга (БР) по специальной формуле
- Обработка отсутствующих данных с fallback значениями
- Экспорт экономических данных в CSV

**Ключевые методы:**
- `fetch_wpcost_data()` - загрузка данных wpcost.blkx с поддержкой множественных URL
- `load_shop_ids()` - загрузка ID из shop.csv
- `calculate_br()` - вычисление боевого рейтинга по формуле
- `extract_unit_data()` - извлечение данных для одного юнита
- `process_wpcost_data()` - обработка всех данных wpcost
- `save_to_csv()` - экспорт экономических данных

#### 5. **misc_and_images_parser.py** - Парсинг дополнительных данных и мультимедиа
**Класс ModernNodesMerger:**
- Объединение данных из всех CSV файлов в единую структуру
- Обогащение основных данных локализацией, экономикой и изображениями
- Создание графа зависимостей на основе поля `predecessor` из shop.csv
- Поддержка совместимости со старым форматом данных
- Детальная статистика покрытия и качества данных

**Ключевые методы:**
- `load_csv_data()` - безопасная загрузка данных из CSV файлов
- `load_supporting_data()` - загрузка вспомогательных данных (локализация, wpcost, изображения)
- `merge_shop_data()` - объединение данных из shop.csv с обогащением
- `extract_dependencies()` - извлечение зависимостей на основе поля predecessor
- `save_merged_data()` - сохранение объединенных данных в vehicles_merged.csv
- `save_dependencies()` - сохранение графа зависимостей в dependencies.csv
- `run_full_merge()` - полный цикл объединения и создания зависимостей
**Класс MiscAndImagesParser:**
- Загрузка и парсинг требований по рангам из rank.blkx
- Проверка доступности флагов стран
- **Сбор изображений техники через GitHub API** с fallback через поля image
- Создание комплексных отчетов о доступности мультимедиа ресурсов
- Отладочные инструменты для диагностики проблем с изображениями

**Ключевые методы:**
- `fetch_rank_data()` - загрузка данных rank.blkx
- `process_rank_data()` - извлечение требований по рангам
- `fetch_country_flags()` - проверка доступности флагов стран
- **НОВОЕ:** `fetch_shop_images()` - сбор изображений техники через GitHub API
- **НОВОЕ:** `_fetch_github_images_list()` - получение списка файлов через GitHub Tree API
- **НОВОЕ:** `_find_image_for_id()` - поиск изображения для конкретного ID
- **НОВОЕ:** `_load_image_fields_fallback()` - загрузка fallback данных из shop_images_fields.csv
- **НОВОЕ:** `_find_image_from_shop_field()` - поиск изображения через поля image как fallback
- **НОВОЕ:** `test_direct_cdn_access()` - отладочная проверка прямого доступа к CDN
- **НОВОЕ:** `debug_search_strategies()` - отладочный анализ стратегий поиска изображений
- Методы сохранения для всех типов данных

#### 7. **main.py** - Точка входа и CLI (ОБНОВЛЕНО)
**Функции:**
- `main()` - полный парсинг (shop + локализация + wpcost + misc + объединение)
- `main_shop_only()` - только парсинг shop.blkx
- `main_localization_only()` - только парсинг локализации
- `main_wpcost_only()` - только парсинг wpcost
- **НОВОЕ:** `main_misc_only()` - только парсинг misc данных (ранги + флаги + изображения)
- **НОВОЕ:** `main_merge_only()` - только объединение данных (требует готовые CSV файлы)
- `print_help()` - справочная информация
- Обработка аргументов командной строки
- Проверка существования конфигурации
- Обработка ошибок и прерываний

## Основные возможности

### Парсер shop.blkx
- **Предварительная очистка** от аномальных элементов с проблемными окончаниями
- **Загрузка данных** из удаленного источника shop.blkx в формате JSON
- **НОВОЕ:** **Извлечение полей image** из всех элементов JSON для fallback поиска изображений
- **Парсинг иерархической структуры** техники по странам и типам
- **Автоматическое определение** премиумных и обычных веток техники
- **Обработка master-slave пар** (техника с зависимыми юнитами)
- **Правильное определение зависимостей** между техникой (предшественники)
- **Обработка групп техники** с правильным наследованием координат
- **Экспорт в CSV** с полной информацией о технике
- **НОВОЕ:** **Создание shop_images_fields.csv** с полями image для fallback поиска изображений

### Парсер локализации
- **Загрузка локализации** из удаленного CSV файла
- **Приоритетная система** обработки различных типов записей
- **Умный поиск** локализации с несколькими стратегиями
- **Обработка групп** и специальных случаев
- **Fallback механизм** для отсутствующих локализаций
- **Создание маппинга** ID → русское название

### Парсер экономических данных
- **Загрузка данных wpcost.blkx** с поддержкой fallback URL для обхода ограничений CDN
- **Извлечение экономических параметров** (value, reqExp, economicRankHistorical)
- **Вычисление боевого рейтинга** по формуле `(economicRankHistorical / 3) + 1`
- **Умное округление БР** до значений X.0, X.3, X.7
- **Обработка отсутствующих данных** с fallback значениями
- **Автоматическое переключение между URL** при недоступности основного источника

### Парсер дополнительных данных и мультимедиа
- **Загрузка требований по рангам** из rank.blkx с извлечением условий открытия новых рангов
- **Проверка доступности флагов стран** с генерацией URL и проверкой статуса ответа
- **НОВОЕ:** **Сбор изображений техники** через GitHub Tree API с анализом всего репозитория War Thunder Datamine
- **НОВОЕ:** **Двухуровневая система поиска изображений:**
  1. **Основной поиск** - через GitHub API с множественными стратегиями поиска (точное совпадение, замена символов, варианты для групп)
  2. **Fallback поиск** - через поля image из shop.blkx при отсутствии файла в репозитории
- **НОВОЕ:** **Отладочные инструменты** для диагностики проблем с изображениями
- **НОВОЕ:** **Статистика доступности** мультимедиа ресурсов с детальными отчетами
- **Загрузка требований по рангам** из rank.blkx с извлечением условий открытия новых рангов
- **Проверка доступности флагов стран** с генерацией URL и проверкой статуса ответа
- **НОВОЕ:** **Сбор изображений техники** через GitHub Tree API с анализом всего репозитория War Thunder Datamine
- **НОВОЕ:** **Двухуровневая система поиска изображений:**
  1. **Основной поиск** - через GitHub API с множественными стратегиями поиска (точное совпадение, замена символов, варианты для групп)
  2. **Fallback поиск** - через поля image из shop.blkx при отсутствии файла в репозитории
- **НОВОЕ:** **Отладочные инструменты** для диагностики проблем с изображениями
- **НОВОЕ:** **Статистика доступности** мультимедиа ресурсов с детальными отчетами

## Структура входных данных

### Формат shop.blkx
```json
{
  "country_germany": {
    "army": {
      "range": [
        {
          "техника_id": {
            "rank": 1,
            "reqAir": "",
            "gift": true,
            "showOnlyWhenBought": true,
            "image": "#ui/unitskin#техника_id"
          },
          "группа_id_group": {
            "image": "#ui/unitskin#группа_id_group",
            "элемент1": { "rank": 1, "image": "#ui/unitskin#элемент1" },
            "элемент2": { "rank": 1, "image": "#ui/unitskin#элемент2" }
          }
        }
      ]
    }
  }
}
```

### Формат файла локализации (CSV)
```csv
"<ID|readonly|noverify>";"<English>";"<French>";"<Italian>";"<German>";"<Spanish>";"<Russian>";"<Polish>"...
"us_m41_walker_bulldog_shop";"M41A1";"M41A1";"M41A1 Walker Bulldog";"M41A1";"M41A1";"M41A1";"M41A1"...
"shop/group/he_112_group";"He 112";"He 112";"He 112";"He 112";"He 112";"He 112";"He 112"...
"cn_t_62_0";"Т-62 №545";"Т-62 №545";"Т-62 N°545";"Т-62 №545";"Т-62 N°545";"Т-62 №545";"Т-62 nr 545"...
```

### Формат файла wpcost.blkx
```json
{
  "economicRankMax": 39,
  "fokker_d7": {
    "value": 700,
    "reqExp": 2900,
    "economicRankHistorical": 15,
    "repairTimeHrsArcade": 111.21,
    "repairCostArcade": 1976,
    "avgAwardArcade": 3965
  },
  "a_10c": {
    "value": 950000,
    "reqExp": 350000,
    "economicRankHistorical": 32
  }
}
```

### Формат файла rank.blkx (НОВОЕ)
```json
{
  "needBuyToOpenNextInEra": {
    "country_usa": {
      "needBuyToOpenNextInEraAircraft1": 6,
      "needBuyToOpenNextInEraAircraft2": 6,
      "needBuyToOpenNextInEraTank1": 6,
      "needBuyToOpenNextInEraTank2": 6
    }
  }
}
```

### GitHub Tree API Response (НОВОЕ)
```json
{
  "tree": [
    {
      "path": "atlases.vromfs.bin_u/units/us_m2a4.png",
      "type": "blob"
    },
    {
      "path": "atlases.vromfs.bin_u/units/germ_pzkpfw_35t.png", 
      "type": "blob"
    }
  ]
}
```

## Алгоритм работы

### 1. Инициализация (main.py)
- Обработка аргументов командной строки
- Проверка существования конфигурационного файла
- Выбор режима работы (полный/только shop/только локализация/только wpcost/только misc)
- Создание экземпляров парсеров
- Обработка ошибок и прерываний

### 2. Настройка компонентов (utils.py)
- Чтение конфигурационного файла через класс `Config`
- Настройка логирования через класс `Logger`
- Загрузка констант из класса `Constants`

### 3. Предварительная очистка данных (shop_parser.py)

#### Система очистки от аномальных элементов (ОБНОВЛЕНО)
**Выполняется ПЕРЕД началом парсинга:**

**Аномальные окончания** (из `Constants.ANOMALOUS_SUFFIXES`):
- `_race` - гоночные события
- `_football` - футбольные события  
- `_yt_cup_2019` - YouTube Cup события
- `_event` - различные события
- `_naval` - морские события

**НОВОЕ: Аномальные начала** (из `Constants.ANOMALOUS_PREFIXES`):
- `ucav_` - беспилотные летательные аппараты (UCAV - Unmanned Combat Aerial Vehicle)
- Возможность добавления других нежелательных префиксов

**Логика удаления "с корнем":**
- **Обычный элемент** с аномальным окончанием или началом → удаляется
- **Группа содержит** аномальные элементы → удаляется вся группа
- **Сама группа** имеет аномальное окончание или начало → удаляется со всем содержимым

**Алгоритм проверки:**
```python
def has_anomalous_suffix(self, element_id: str) -> bool:
    # Проверка окончаний (существующая логика)
    has_suffix = any(element_id.endswith(suffix) for suffix in Constants.ANOMALOUS_SUFFIXES)
    
    # Проверка начал (новая логика)
    has_prefix = any(element_id.startswith(prefix) for prefix in Constants.ANOMALOUS_PREFIXES)
    
    return has_suffix or has_prefix
```

**Примеры удаляемых элементов:**
- Окончания: `some_unit_race`, `vehicle_event`, `ship_naval`
- Начала: `ucav_predator`, `ucav_reaper`, `ucav_any_variant`

### 4. Извлечение полей image (shop_parser.py) (НОВОЕ)

#### Процесс извлечения image полей
**Выполняется ПОСЛЕ очистки данных:**

**Поиск полей image:**
- Обработка всех элементов в очищенных данных shop.blkx
- Поиск поля `image` как в основных элементах, так и в элементах групп
- Форматирование: извлечение имени после символа `#` (например: `#ui/unitskin#us_sherman_group` → `us_sherman_group`)
- Приведение ID к нижнему регистру для совместимости

**Результат:**
```python
self.image_fields = {
    'us_sherman_group': 'us_sherman_group',
    'germ_pzkpfw_35t': 'germ_pzkpfw_35t',
    'he_112_group': 'he_112_group'
}
```

**Сохранение в shop_images_fields.csv:**
```csv
id,image_field
us_sherman_group,us_sherman_group
germ_pzkpfw_35t,germ_pzkpfw_35t
he_112_group,he_112_group
```

### 5. Парсинг shop.blkx (shop_parser.py)
#### Сбор master-slave пар
**Выполняется ПОСЛЕ очистки данных и извлечения image полей:**
- Поиск элементов с полем `slaveUnit`
- Создание словаря пар `master_id -> slave_id`
- Формирование списка slave-юнитов для пропуска

#### Определение премиумных колонок
**Критерии премиумности:**
- Процент премиумной техники ≥ 30% (настраивается в `Constants.PREMIUM_THRESHOLD`)
- **Признаки премиумной техники** (из `Constants.PREMIUM_INDICATORS`):
  - `showOnlyWhenBought`, `gift`, `marketplaceItemdefId`, `isClanVehicle`
  - `showOnlyWhenResearch`, `event`, `hideFeature`
  - `beginPurchaseDate`/`endPurchaseDate`, `hideByPlatform`

[Остальные разделы парсинга shop.blkx остаются без изменений]

### 6. Парсинг локализации (localization_parser.py)
[Раздел остается без изменений]

### 7. Парсинг экономических данных (wpcost_parser.py)
[Раздел остается без изменений]

### 8. Парсинг дополнительных данных и мультимедиа (misc_and_images_parser.py)

#### Загрузка и объединение данных
**Процесс объединения:**
- Загрузка основных данных из `shop.csv` как базовая структура
- Загрузка вспомогательных данных: `localization.csv`, `wpcost.csv`, `shop_images.csv`
- Создание словарей для быстрого поиска по ID
- Обогащение основных данных локализацией, экономикой и изображениями

**Обогащение данных:**
- **Локализация:** добавление русских названий из `localization.csv`
- **Экономика:** добавление данных о серебре, опыте и БР из `wpcost.csv`  
- **Изображения:** добавление URL изображений из `shop_images.csv`
- **Совместимость:** создание полей для совместимости со старым форматом

#### Создание графа зависимостей
**Алгоритм извлечения зависимостей:**
- Основа: поле `predecessor` из `shop.csv`
- Создание словаря всех узлов для валидации существования предшественников
- Проверка каждого узла на наличие предшественника
- Fallback логика: поиск предшественника с суффиксом `_group` для совместимости
- Создание записей зависимостей в формате `{node_external_id: child, prerequisite_external_id: parent}`

**Особенности обработки:**
- **Премиум техника:** имеет пустое поле `predecessor` (без зависимостей)
- **Группы/папки:** могут быть как предшественниками, так и потомками
- **Валидация:** проверка существования всех предшественников в наборе данных
- **Статистика:** подсчет найденных, пропущенных и отсутствующих зависимостей

#### Результаты объединения
**Создаваемые файлы:**
- `vehicles_merged.csv` - полная информация о технике с обогащенными данными
- `dependencies.csv` - граф зависимостей между техникой

**Статистика качества:**
- Процент покрытия локализацией (найдено русских названий)
- Процент покрытия экономическими данными (найдено цен, опыта, БР)
- Процент покрытия изображениями (найдено URL изображений)
- Статистика зависимостей (найдено связей, пропущено, ошибок)

#### Совместимость и миграция
**Поддержка старого формата:**
- Создание полей `data_ulist_id`, `external_id` для совместимости
- Копирование `predecessor` в `parent_external_id`
- Форматирование `br` как `battle_rating` (строка)
- Маппинг `status` в `tech_category`

**Сравнение с предыдущей версией:**
- **Точность данных:** 99.1% совпадение зависимостей с веб-скрапингом (2182 vs 2231)
- **Потерянные связи:** 2 зависимости (ah_64a→ah_1f, ah_6m→uh_1b) 
- **Причина потерь:** улучшенная фильтрация и очистка от аномальных элементов
- **Качество:** данные из игровых файлов более точные чем веб-скрапинг

#### Загрузка и обработка требований по рангам
**Алгоритм обработки rank.blkx:**
- Загрузка JSON данных из удаленного источника
- Поиск секции `needBuyToOpenNextInEra`
- Извлечение требований по паттерну `needBuyToOpenNextInEra{Type}{Rank}`
- Маппинг типов техники через `Constants.RANK_TYPE_MAPPING`
- Создание записей с информацией о требуемом количестве юнитов для открытия следующего ранга

#### Проверка доступности флагов стран
**Процесс проверки флагов:**
- Итерация по всем странам из `Constants.COUNTRY_MAPPING`
- Формирование URL: `{FLAGS_BASE_URL}country_{country_code}.svg`
- HTTP HEAD запрос для проверки доступности
- Создание записей с URL для доступных флагов и пустыми для недоступных

#### Сбор изображений техники (НОВОЕ)
**Двухуровневая система поиска:**

**Уровень 1 - GitHub API:**
- Использование GitHub Tree API для получения полного списка файлов из репозитория War Thunder Datamine
- Фильтрация файлов из папки `atlases.vromfs.bin_u/units/` с расширением `.png`
- Создание словаря доступных изображений: `filename_without_extension -> CDN_URL`

**Стратегии поиска через GitHub API:**
1. **Точное совпадение** - поиск точного ID
2. **Замена символов** - замена дефисов на подчеркивания и наоборот
3. **Варианты для групп** - дополнительные стратегии для элементов с суффиксом `_group`
4. **Позиционные варианты** - добавление дефисов в разных позициях (например: `he51` → `he-51`)

**Уровень 2 - Fallback через поля image:**
- Загрузка данных из `shop_images_fields.csv` (созданного shop_parser)
- Поиск ID в fallback данных при отсутствии в GitHub
- Формирование URL: `{IMAGES_BASE_URL}{image_name}.png`

**Отладочные инструменты:**
- `test_direct_cdn_access()` - прямая проверка доступности изображений через CDN
- `debug_search_strategies()` - анализ стратегий поиска для проблемных ID
- `debug_github_api()` - диагностика работы GitHub Tree API
- Детальное логирование всех этапов поиска

**Статистика результатов:**
- Количество найденных обычным поиском
- Количество найденных через fallback
- Процент успешного нахождения изображений
- Список проблемных ID для анализа

## Выходные данные

### Формат shop.csv
```csv
id,rank,country,vehicle_type,type,status,column_index,row_index,predecessor,order_in_folder
germ_pzkpfw_35t,1,germany,Наземная техника,vehicle,standard,0,0,,
germ_pzkpfw_38t_group,1,germany,Наземная техника,folder,standard,0,0,germ_pzkpfw_35t,
germ_pzkpfw_38t_ausf_F,1,germany,Наземная техника,vehicle,standard,0,0,germ_pzkpfw_38t_group,0
```

### Формат shop_images_fields.csv (НОВОЕ)
```csv
id,image_field
us_sherman_group,us_sherman_group
germ_pzkpfw_35t,germ_pzkpfw_35t
he_112_group,he_112_group
```

### Формат localization.csv
```csv
id,localized_name
us_m41_walker_bulldog,M41A1
ussr_zsu_37_2,ЗСУ-37-2
he_112_group,He 112
cn_t_62,Т-62 №545
```

### Формат wpcost.csv
```csv
id,silver,exp,br
a_10c,950000,350000,11.7
f4d_1,520000,190000,9.0
fokker_d7,700,2900,6.0
unit_without_data,0,,1.0
premium_unit,0,,5.3
```

### Формат rank_requirements.csv (НОВОЕ)
```csv
nation,vehicle_type,target_rank,previous_rank,required_units
usa,Авиация,2,1,6
usa,Наземная техника,2,1,6
germany,Авиация,3,2,6
```

### Формат country_flags.csv (НОВОЕ)
```csv
country,flag_image_url
usa,https://wiki.warthunder.ru/static/country_svg/country_usa.svg
germany,https://wiki.warthunder.ru/static/country_svg/country_germany.svg
ussr,
```

### Формат shop_images.csv (НОВОЕ)
```csv
id,image_url
us_m2a4,https://static.encyclopedia.warthunder.com/slots/us_m2a4.png
us_m3_stuart,https://static.encyclopedia.warthunder.com/slots/us_m3_stuart.png
us_sherman_group,https://static.encyclopedia.warthunder.com/slots/us_sherman_group.png
missing_unit,
fallback_unit,https://static.encyclopedia.warthunder.com/slots/fallback_unit.png
```

### Описание полей (обновлено)

#### shop.csv (из Constants.CSV_FIELDNAMES):
- **id:** Уникальный идентификатор техники (нижний регистр)
- **rank:** Ранг техники (1-8)
- **country:** Страна (germany, usa, ussr, etc.)
- **vehicle_type:** Тип техники (Наземная техника, Авиация, etc.)
- **type:** vehicle или folder
- **status:** standard или premium
- **column_index:** Номер колонки (для премиум техники: 0, 1, 2...)
- **row_index:** Позиция в колонке
- **predecessor:** ID предшественника (пусто для премиум техники)
- **order_in_folder:** Порядок в группе (0, 1, 2... или пусто)

#### shop_images_fields.csv (из Constants.SHOP_IMAGES_FIELDS_CSV_FIELDNAMES) (НОВОЕ):
- **id:** Уникальный идентификатор техники (совпадает с shop.csv)
- **image_field:** Имя изображения из поля image в shop.blkx

#### localization.csv (из Constants.LOCALIZATION_CSV_FIELDNAMES):
- **id:** Уникальный идентификатор техники (совпадает с shop.csv)
- **localized_name:** Русское название техники

#### wpcost.csv (из Constants.WPCOST_CSV_FIELDNAMES):
- **id:** Уникальный идентификатор техники (подмножество shop.csv)
- **silver:** Стоимость покупки в серебре (0 если данных нет)
- **exp:** Требуемый опыт для исследования (пусто если 0 или данных нет)
- **br:** Боевой рейтинг (вычисленный или 1.0 fallback)

#### rank_requirements.csv (из Constants.RANK_REQUIREMENTS_CSV_FIELDNAMES) (НОВОЕ):
- **nation:** Страна (usa, germany, ussr, etc.)
- **vehicle_type:** Тип техники (Авиация, Наземная техника, etc.)
- **target_rank:** Целевой ранг для открытия
- **previous_rank:** Предыдущий ранг
- **required_units:** Количество требуемых юнитов

#### country_flags.csv (из Constants.COUNTRY_FLAGS_CSV_FIELDNAMES) (НОВОЕ):
- **country:** Код страны
- **flag_image_url:** URL изображения флага (пусто если недоступен)

#### shop_images.csv (из Constants.SHOP_IMAGES_CSV_FIELDNAMES) (НОВОЕ):
- **id:** Уникальный идентификатор техники (подмножество shop.csv)
- **image_url:** URL изображения техники (пусто если не найдено)

## Конфигурация

### config.txt (ОБНОВЛЕНО)
```
# Основные источники данных
shop_url=https://cdn.jsdelivr.net/gh/gszabi99/War-Thunder-Datamine@master/char.vromfs.bin_u/config/shop.blkx

localization_url=https://cdn.jsdelivr.net/gh/gszabi99/War-Thunder-Datamine@master/lang.vromfs.bin_u/lang/units.csv

# Основной URL для wpcost (jsdelivr ограничен 20 МБ)
wpcost_url=https://cdn.jsdelivr.net/gh/gszabi99/War-Thunder-Datamine@master/char.vromfs.bin_u/config/wpcost.blkx

# Fallback URL для больших файлов (через запятую)
wpcost_fallback_urls=https://github.com/gszabi99/War-Thunder-Datamine/raw/master/char.vromfs.bin_u/config/wpcost.blkx,https://cdn.statically.io/gh/gszabi99/War-Thunder-Datamine/master/char.vromfs.bin_u/config/wpcost.blkx,https://gitcdn.xyz/repo/gszabi99/War-Thunder-Datamine/master/char.vromfs.bin_u/config/wpcost.blkx

# URL для требований по рангам (НОВОЕ)
rank_url=https://cdn.jsdelivr.net/gh/gszabi99/War-Thunder-Datamine@master/char.vromfs.bin_u/config/rank.blkx

# Настройки отладки
debug_mode=true
save_intermediate_files=true
```

### Настройки в Constants (обновлено)
- `PREMIUM_THRESHOLD = 0.3` - порог определения премиум колонки (30%)
- `PROCESS_SLAVE_UNITS = False` - обрабатывать ли slave-юниты
- `ANOMALOUS_SUFFIXES = ['_race', '_football', '_yt_cup_2019', '_event', '_naval']` - аномальные окончания
- **НОВОЕ:** `ANOMALOUS_PREFIXES = ['ucav_']` - аномальные начала для удаления
- `FLAGS_BASE_URL = 'https://wiki.warthunder.ru/static/country_svg/'` - базовый URL для флагов
- `IMAGES_BASE_URL = 'https://static.encyclopedia.warthunder.com/slots/'` - базовый URL для изображений
- `GITHUB_API_BASE_URL = 'https://api.github.com'` - базовый URL для GitHub API
- Поля для всех типов CSV файлов (7 различных наборов)

## Логирование

### Конфигурация логирования (Logger класс) (ОБНОВЛЕНО)
- **shop_parser_debug.log** - полная отладочная информация парсера shop.blkx (DEBUG уровень)
- **localization_parser_debug.log** - полная отладочная информация парсера локализации (DEBUG уровень)
- **wpcost_parser_debug.log** - полная отладочная информация парсера wpcost (DEBUG уровень)
- **misc_and_images_parser_debug.log** - полная отладочная информация парсера misc данных (DEBUG уровень)
- **nodes_merger_debug.log** - полная отладочная информация объединения данных (DEBUG уровень) (НОВОЕ)
- **Консоль** - основные этапы работы (INFO уровень)

### Уровни логирования
- **INFO:** Основные этапы (очистка, загрузка, обработка стран, сохранение)
- **DEBUG:** Детальная информация о каждом элементе, очистке, поиске локализации, вычислении БР и поиске изображений
- **WARNING:** Проблемы с данными, переключение между URL, недоступные ресурсы
- **ERROR:** Критические ошибки

### Примеры логов misc парсера
```
Загрузка данных rank.blkx из: https://cdn.jsdelivr.net/gh/.../rank.blkx
Извлечено требований по рангам: 45
Сбор данных о флагах стран...
  Флаг найден: usa
  Флаг недоступен: china (статус: 404)
Статистика флагов стран: Найдено: 8, Недоступно: 2, Всего обработано: 10

Загрузка списка изображений из GitHub...
GitHub Tree API вернул 15420 элементов
PNG файлов: 3847
=== ОТЛАДКА: Анализ первых 5 ID ===
=== DEBUG: Поиск для us_m2a4 ===
Пробуем варианты: ['us_m2a4', 'us_m2a4', 'us-m2a4']
  ✅ НАЙДЕН: us_m2a4 -> https://static.encyclopedia.warthunder.com/slots/us_m2a4.png

Статистика изображений техники:
  Найдено обычным поиском: 2847
  Найдено через fallback: 234
  Всего найдено: 3081
  Недоступно: 156
  Всего обработано: 3237
  Процент успеха: 95.2%
```
```
Загрузка данных rank.blkx из: https://cdn.jsdelivr.net/gh/.../rank.blkx
Извлечено требований по рангам: 45
Сбор данных о флагах стран...
  Флаг найден: usa
  Флаг недоступен: china (статус: 404)
Статистика флагов стран: Найдено: 8, Недоступно: 2, Всего обработано: 10

Загрузка списка изображений из GitHub...
GitHub Tree API вернул 15420 элементов
PNG файлов: 3847
=== ОТЛАДКА: Анализ первых 5 ID ===
=== DEBUG: Поиск для us_m2a4 ===
Пробуем варианты: ['us_m2a4', 'us_m2a4', 'us-m2a4']
  ✅ НАЙДЕН: us_m2a4 -> https://static.encyclopedia.warthunder.com/slots/us_m2a4.png

Статистика изображений техники:
  Найдено обычным поиском: 2847
  Найдено через fallback: 234
  Всего найдено: 3081
  Недоступно: 156
  Всего обработано: 3237
  Процент успеха: 95.2%
```

## Статистика выполнения

### По shop.blkx парсеру:
- Количество удаленных аномальных элементов
- **НОВОЕ:** Количество извлеченных полей image
- Общее количество обработанных элементов
- Количество стандартной и премиумной техники
- Количество найденных master-slave пар
- Количество пропущенных slave-юнитов

### По парсеру локализации:
- Количество обработанных строк из CSV
- Количество найденных локализаций
- Количество fallback (не найденных) записей
- Статистика по приоритетам

### По парсеру wpcost:
- Количество ID из shop.csv
- Количество найденных в wpcost.blkx
- Количество пропущенных (не найденных)
- Количество записей с опытом
- Количество записей с fallback БР (1.0)
- Информация о попытках загрузки и использованных URL

### По парсеру misc данных:
- **Требования по рангам:** количество извлеченных требований
- **Флаги стран:** количество найденных vs недоступных флагов
- **Изображения техники:**
  - Количество ID из shop.csv для обработки
  - Количество найденных через GitHub API
  - Количество найденных через fallback (поля image)
  - Процент успешного нахождения изображений
  - Список проблемных ID для анализа
  - Информация о попытках доступа к CDN
- **Требования по рангам:** количество извлеченных требований
- **Флаги стран:** количество найденных vs недоступных флагов
- **Изображения техники:**
  - Количество ID из shop.csv для обработки
  - Количество найденных через GitHub API
  - Количество найденных через fallback (поля image)
  - Процент успешного нахождения изображений
  - Список проблемных ID для анализа
  - Информация о попытках доступа к CDN

## Обработка ошибок

### На уровне main.py:
- Проверка существования конфигурационного файла
- Обработка прерывания пользователем (Ctrl+C)
- Вывод пользовательских сообщений об ошибках
- Graceful обработка ошибок всех модулей (продолжение работы без критичных модулей)

### На уровне компонентов:
- **Config:** валидация конфигурационного файла
- **ShopParser:** проверка структуры данных, graceful handling сетевых ошибок, защита от аномальных элементов, обработка отсутствующих image полей
- **LocalizationParser:** обработка некорректных CSV строк, приоритетное разрешение конфликтов
- **WpcostParser:** автоматическое переключение между URL, обработка больших файлов, fallback для некорректных данных
- **MiscAndImagesParser:** обработка таймаутов GitHub API, fallback при недоступности изображений, graceful handling проблем с CDN (НОВОЕ)
- **Logger:** логирование предупреждений для некорректных элементов

## Требования к окружению

- **Python 3.7+**
- **Стандартные библиотеки:** json, csv, logging, typing, sys, os, re
- **Внешние библиотеки:** requests
- **Файлы:** 
  - config.txt с корректными URL (shop_url, localization_url, wpcost_url, wpcost_fallback_urls, rank_url)
  - shop.csv (для работы только парсеров локализации, wpcost и misc)
  - shop_images_fields.csv (автоматически создается shop_parser, используется misc_parser для fallback)

## Использование

### Полный парсинг (shop + локализация + wpcost + misc) (ОБНОВЛЕНО)
```bash
python main.py
python main.py --config my_config.txt
```

### Только парсинг shop.blkx
```bash
python main.py --shop-only
python main.py --config my_config.txt --shop-only
```

### Только парсинг локализации
```bash
python main.py --localization-only
python main.py --config my_config.txt --localization-only
```

### Только парсинг wpcost
```bash
python main.py --wpcost-only
python main.py --config my_config.txt --wpcost-only
```

### Только парсинг misc данных
```bash
python main.py --misc-only
python main.py --config my_config.txt --misc-only
```
```bash
python main.py --misc-only
python main.py --config my_config.txt --misc-only
```

### Справка (ОБНОВЛЕНО)
```bash
python main.py --help
```

### Результат выполнения (ОБНОВЛЕНО):
- **shop.csv** - основные данные техники (очищенные от аномальных элементов)
- **shop_images_fields.csv** - поля image из shop.blkx для fallback поиска изображений
- **localization.csv** - маппинг ID → русские названия
- **wpcost.csv** - экономические данные (серебро, опыт, БР)
- **rank_requirements.csv** - требования по рангам для открытия новых рангов
- **country_flags.csv** - флаги стран с проверкой доступности
- **shop_images.csv** - изображения техники с двухуровневым поиском
- **vehicles_merged.csv** - полные объединенные данные о технике с локализацией и экономикой (НОВОЕ)
- **dependencies.csv** - граф зависимостей между техникой (ОБНОВЛЕНО)
- **shop_parser_debug.log** - подробный лог парсера shop.blkx с информацией об очистке и извлечении image полей
- **localization_parser_debug.log** - подробный лог парсера локализации
- **wpcost_parser_debug.log** - подробный лог парсера wpcost с информацией о вычислениях БР
- **misc_and_images_parser_debug.log** - подробный лог парсера misc данных с отладкой поиска изображений
- **nodes_merger_debug.log** - подробный лог объединения данных с статистикой покрытия (НОВОЕ)
- Статистика в консоли включая информацию об удаленных элементах, экономических данных, мультимедиа ресурсах и объединении данных

## Расширяемость архитектуры

### Добавление новых типов аномальных элементов (ОБНОВЛЕНО):

#### Добавление аномальных окончаний:
1. Добавить новые окончания в `Constants.ANOMALOUS_SUFFIXES`
```python
ANOMALOUS_SUFFIXES = ['_race', '_football', '_yt_cup_2019', '_event', '_naval', '_new_suffix']
```

#### Добавление аномальных начал (НОВОЕ):
1. Добавить новые начала в `Constants.ANOMALOUS_PREFIXES`
```python
ANOMALOUS_PREFIXES = ['ucav_', 'test_', 'dev_', 'prototype_']
```

#### Расширение логики проверки:
При необходимости можно расширить метод `has_anomalous_suffix()` для более сложных паттернов:
```python
def has_anomalous_suffix(self, element_id: str) -> bool:
    # Проверка окончаний
    has_suffix = any(element_id.endswith(suffix) for suffix in Constants.ANOMALOUS_SUFFIXES)
    
    # Проверка начал
    has_prefix = any(element_id.startswith(prefix) for prefix in Constants.ANOMALOUS_PREFIXES)
    
    # Дополнительная логика (например, содержит определенную подстроку)
    # has_substring = 'unwanted' in element_id
    
    return has_suffix or has_prefix  # or has_substring
```

### Добавление новых форматов экспорта:
1. Создать новый метод в соответствующем парсере (например, `save_to_json()`)
2. Добавить константы в `Constants` при необходимости

### Добавление новых источников данных:
1. Расширить методы `fetch_*_data()` в соответствующих парсерах
2. Добавить новые URL в конфигурацию
3. Реализовать поддержку fallback URL по образцу wpcost парсера

### Добавление новых языков локализации:
1. Изменить индекс колонки в `parse_localization_csv()`
2. Добавить параметр языка в конфигурацию

### Добавление новых экономических параметров:
1. Расширить метод `extract_unit_data()` в `WpcostParser`
2. Добавить новые поля в `Constants.WPCOST_CSV_FIELDNAMES`
3. Обновить алгоритмы обработки данных

### Расширение системы поиска изображений (НОВОЕ):
1. Добавить новые стратегии поиска в `_find_image_for_id()`
2. Реализовать дополнительные источники изображений (например, другие CDN)
3. Добавить поддержку различных форматов изображений
4. Создать систему кеширования для GitHub API запросов

### Добавление новых типов мультимедиа контента (НОВОЕ):
1. Создать методы для поиска других типов ресурсов (звуки, модели)
2. Расширить GitHub API интеграцию для других папок репозитория
3. Добавить проверку доступности других CDN ресурсов

### Добавление новых типов логирования:
1. Расширить класс `Logger` в `utils.py`
2. Добавить новые обработчики логов

### Интеграция с базами данных:
1. Создать новый модуль `database_manager.py`
2. Объединить данные из всех CSV файлов
3. Добавить методы для работы с различными СУБД

### Улучшение системы обработки больших файлов:
1. Добавить поддержку streaming загрузки для файлов > 100 МБ
2. Реализовать кеширование больших файлов локально
3. Добавить поддержку сжатых форматов (gzip, brotli)

### Улучшение системы вычисления БР:
1. Добавить поддержку альтернативных формул БР для разных типов техники
2. Реализовать валидацию вычисленных значений БР
3. Добавить поддержку исторических изменений формул БР

### Улучшение системы fallback URL:
1. Добавить автоматическое определение зеркал репозитория
2. Реализовать проверку доступности URL перед использованием
3. Добавить кеширование информации о работоспособности URL

### Расширение отладочных инструментов:
1. Добавить веб-интерфейс для просмотра статистики парсинга
2. Создать систему мониторинга изменений в исходных данных
3. Реализовать автоматические уведомления о проблемах с данными
4. Добавить визуализацию дерева техники и зависимостей
1. Добавить веб-интерфейс для просмотра статистики парсинга
2. Создать систему мониторинга изменений в исходных данных
3. Реализовать автоматические уведомления о проблемах с данными
4. Добавить визуализацию дерева техники и зависимостей

## Технические особенности новой версии

### Обработка больших файлов:
- **Автоматическое переключение** между CDN при ошибках 403
- **Поддержка файлов > 20 МБ** через fallback URL
- **Увеличенный timeout** для загрузки больших файлов (45 сек для wpcost, 60 сек для GitHub API)
- **Мониторинг размера файла** с выводом в логи

### Улучшенная обработка данных:
- **Fallback значения** для всех критических параметров
- **Умная валидация** входных данных с типизацией
- **Специальная логика** для обработки нулевых значений опыта
- **Гарантированные числовые БР** (минимум 1.0)
- **НОВОЕ:** **Двухуровневая система поиска изображений** с основным и fallback режимами

### Расширенная статистика:
- **Детальная информация** о попытках загрузки
- **Статистика по fallback значениям** 
- **Мониторинг качества данных** (процент успешных вычислений)
- **Информация об использованных URL** и CDN
- **НОВОЕ:** **Статистика доступности мультимедиа ресурсов** с процентом успеха и проблемными элементами

### Система извлечения image полей:
- **Автоматическое извлечение** полей image из всех элементов shop.blkx
- **Форматирование путей** изображений (удаление префикса `#ui/unitskin#`)
- **Создание fallback файла** shop_images_fields.csv для использования misc парсером
- **Интеграция с поиском изображений** через двухуровневую систему
- **Автоматическое извлечение** полей image из всех элементов shop.blkx
- **Форматирование путей** изображений (удаление префикса `#ui/unitskin#`)
- **Создание fallback файла** shop_images_fields.csv для использования misc парсером
- **Интеграция с поиском изображений** через двухуровневую систему

### Интеграция с GitHub API (НОВОЕ):
- **Использование GitHub Tree API** для получения полного списка файлов репозитория
- **Рекурсивный обход** структуры репозитория War Thunder Datamine
- **Фильтрация по папкам и типам файлов** для оптимизации поиска
- **Обработка таймаутов и ошибок** при работе с GitHub API
- **Кеширование результатов** запросов для повышения производительности

## Архитектурные принципы

### Модульность:
- Каждый парсер - отдельный самодостаточный модуль
- Общие компоненты вынесены в utils.py
- Возможность запуска любого парсера независимо
- **НОВОЕ:** Интеграция между модулями через файлы CSV (shop_images_fields.csv)

### Отказоустойчивость:
- Graceful handling всех типов ошибок
- Автоматическое переключение между источниками данных
- Fallback значения для критически важных параметров
- Продолжение работы при недоступности отдельных модулей
- **НОВОЕ:** Двухуровневая система поиска ресурсов с множественными fallback стратегиями

### Масштабируемость:
- Легкое добавление новых парсеров по образцу существующих
- Конфигурируемые параметры через файл настроек
- Расширяемая система констант и маппингов
- Поддержка различных форматов входных и выходных данных
- **НОВОЕ:** Гибкая система поиска мультимедиа ресурсов с возможностью добавления новых источников

### Наблюдаемость:
- Подробное логирование всех операций
- Статистика выполнения для каждого модуля
- Отладочная информация для диагностики проблем
- Мониторинг производительности и качества данных
- **НОВОЕ:** Специализированные отладочные инструменты для диагностики проблем с мультимедиа ресурсами

### Совместимость данных:
- Все ID приведены к нижнему регистру для совместимости
- Единая система именования файлов
- Стандартизированные форматы CSV
- **НОВОЕ:** Автоматическая интеграция между парсерами через промежуточные файлы

## Заключение

Модульная архитектура с интегрированными системами очистки, локализации, экономических данных и мультимедиа ресурсов обеспечивает комплексную обработку информации War Thunder с возможностью гибкой фильтрации нежелательного контента. 

### Ключевые преимущества системы:

**Стабильность и надежность:**
- Стабильная работа с любыми входными данными
- Автоматическое переключение между источниками при проблемах с доступностью
- **Универсальная система фильтрации** аномальных элементов по окончаниям и началам

**Функциональность:**
- Интеллектуальный поиск изображений техники через множественные источники
- Система приоритетов в парсере локализации для корректной обработки конфликтующих записей
- **Предварительная очистка** защищает от проблемных элементов (беспилотники, тестовый контент, события)
- Парсер экономических данных с автоматическим вычислением боевых рейтингов

**Расширяемость:**
- Легкая поддержка и развитие проекта без нарушения существующей функциональности
- **Простое добавление новых паттернов фильтрации** через константы
- Модульная архитектура позволяет добавлять новые типы данных и источников

**Мониторинг и отладка:**
- Полная картина доступности изображений, флагов и других визуальных элементов игры
- Детальное логирование процесса очистки с указанием причин удаления
- Статистика по всем этапам обработки данных

Система готова к работе с реальными данными War Thunder и может быть легко адаптирована для фильтрации любого нежелательного контента путем добавления соответствующих префиксов или суффиксов в конфигурационные константы. **Новый модуль объединения данных обеспечивает создание полной картины игрового дерева техники с 99.1% точностью зависимостей**, объединяя структурную информацию с локализацией, экономическими данными и мультимедиа ресурсами в единую систему.