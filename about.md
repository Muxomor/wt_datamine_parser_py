# Техническое задание: Парсер shop.blkx для War Thunder с модулями локализации и экономических данных

## Описание проекта

Модульное Python-приложение для парсинга данных shop.blkx из игры War Thunder и преобразования их в структурированные CSV-файлы с поддержкой локализации и экономических данных. Приложение обрабатывает древовидную структуру техники различных стран, типов и рангов, правильно определяет зависимости между техникой и разделяет обычную и премиумную технику, создает файл локализации с русскими названиями юнитов, а также извлекает экономические данные (серебро, опыт, боевой рейтинг). Включает предварительную очистку от аномальных элементов для обеспечения стабильной работы.

## Архитектура проекта

### Структура файлов
```
project/
├── utils.py                  # Конфигурация, логирование и константы
├── shop_parser.py            # Основная логика парсинга shop.blkx
├── localization_parser.py    # Парсинг локализации юнитов
├── wpcost_parser.py          # Парсинг экономических данных (NEW)
├── main.py                   # Точка входа и CLI интерфейс
├── config.txt                # Конфигурационный файл
└── README.md                 # Документация
```

### Модули приложения

#### 1. **utils.py** - Инфраструктура и настройки
**Классы:**
- **Config** - чтение и управление конфигурацией из файла
- **Logger** - настройка логирования в файл и консоль
- **Constants** - все константы приложения (пороги, маппинги, поля)

**Основные константы:**
- `PREMIUM_THRESHOLD = 0.3` - порог определения премиум колонки (30%)
- `PROCESS_SLAVE_UNITS = False` - обрабатывать ли slave-юниты
- `VEHICLE_TYPE_MAPPING` - маппинг типов техники
- `COUNTRY_MAPPING` - маппинг стран
- `PREMIUM_INDICATORS` - признаки премиумной техники
- `ANOMALOUS_SUFFIXES` - список аномальных окончаний для удаления
- `LOCALIZATION_CSV_FIELDNAMES` - поля для CSV локализации
- `WPCOST_CSV_FIELDNAMES` - поля для CSV экономических данных (NEW)

#### 2. **shop_parser.py** - Основная бизнес-логика
**Класс ShopParser:**
- Предварительная очистка от аномальных элементов
- Загрузка данных из удаленного источника shop.blkx
- Парсинг иерархической структуры техники
- Обработка master-slave пар и групп
- Определение зависимостей и координат
- Экспорт результатов в CSV

**Ключевые методы:**
- `fetch_shop_data()` - загрузка данных shop.blkx
- `has_anomalous_suffix()` - проверка на аномальные окончания
- `clean_anomalous_elements()` - предварительная очистка данных
- `collect_master_slave_pairs()` - предварительный сбор пар
- `parse_shop_data()` - основной парсинг с очисткой
- `process_country_data()` - обработка данных страны
- `save_to_csv()` - экспорт в CSV

#### 3. **localization_parser.py** - Парсинг локализации
**Класс LocalizationParser:**
- Загрузка данных локализации из удаленного источника CSV
- Парсинг CSV файла локализации с приоритетной системой
- Сопоставление ID юнитов с русскими названиями
- Обработка различных типов записей (shop, группы, числовые суффиксы)
- Экспорт маппинга локализации в CSV

**Ключевые методы:**
- `fetch_localization_data()` - загрузка CSV локализации
- `parse_localization_csv()` - парсинг с приоритетами
- `load_shop_ids()` - загрузка ID из shop.csv
- `create_localization_mapping()` - создание маппинга ID → название
- `_find_localization_for_id()` - умный поиск локализации
- `save_to_csv()` - экспорт локализации

#### 4. **wpcost_parser.py** - Парсинг экономических данных (NEW)
**Класс WpcostParser:**
- Загрузка данных wpcost.blkx из удаленного источника с поддержкой fallback URL
- Извлечение экономических параметров (серебро, опыт, боевой рейтинг)
- Вычисление боевого рейтинга (БР) по специальной формуле
- Обработка отсутствующих данных с fallback значениями
- Экспорт экономических данных в CSV

**Ключевые методы:**
- `fetch_wpcost_data()` - загрузка данных wpcost.blkx с поддержкой множественных URL
- `load_shop_ids()` - загрузка ID из shop.csv
- `calculate_br()` - вычисление боевого рейтинга по формуле
- `extract_unit_data()` - извлечение данных для одного юнита
- `process_wpcost_data()` - обработка всех данных wpcost
- `save_to_csv()` - экспорт экономических данных

#### 5. **main.py** - Точка входа и CLI
**Функции:**
- `main()` - полный парсинг (shop + локализация + wpcost)
- `main_shop_only()` - только парсинг shop.blkx
- `main_localization_only()` - только парсинг локализации
- `main_wpcost_only()` - только парсинг wpcost (NEW)
- `print_help()` - справочная информация
- Обработка аргументов командной строки
- Проверка существования конфигурации
- Обработка ошибок и прерываний

## Основные возможности

### Парсер shop.blkx
- **Предварительная очистка** от аномальных элементов с проблемными окончаниями
- **Загрузка данных** из удаленного источника shop.blkx в формате JSON
- **Парсинг иерархической структуры** техники по странам и типам
- **Автоматическое определение** премиумных и обычных веток техники
- **Обработка master-slave пар** (техника с зависимыми юнитами)
- **Правильное определение зависимостей** между техникой (предшественники)
- **Обработка групп техники** с правильным наследованием координат
- **Экспорт в CSV** с полной информацией о технике

### Парсер локализации
- **Загрузка локализации** из удаленного CSV файла
- **Приоритетная система** обработки различных типов записей
- **Умный поиск** локализации с несколькими стратегиями
- **Обработка групп** и специальных случаев
- **Fallback механизм** для отсутствующих локализаций
- **Создание маппинга** ID → русское название

### Парсер экономических данных (NEW)
- **Загрузка данных wpcost.blkx** с поддержкой fallback URL для обхода ограничений CDN
- **Извлечение экономических параметров** (value, reqExp, economicRankHistorical)
- **Вычисление боевого рейтинга** по формуле `(economicRankHistorical / 3) + 1`
- **Умное округление БР** до значений X.0, X.3, X.7
- **Обработка отсутствующих данных** с fallback значениями
- **Автоматическое переключение между URL** при недоступности основного источника

## Структура входных данных

### Формат shop.blkx
```json
{
  "country_germany": {
    "army": {
      "range": [
        {
          "техника_id": {
            "rank": 1,
            "reqAir": "",
            "gift": true,
            "showOnlyWhenBought": true
          },
          "группа_id_group": {
            "image": "#ui/unitskin#группа_id_group",
            "элемент1": { "rank": 1 },
            "элемент2": { "rank": 1 }
          }
        }
      ]
    }
  }
}
```

### Формат файла локализации (CSV)
```csv
"<ID|readonly|noverify>";"<English>";"<French>";"<Italian>";"<German>";"<Spanish>";"<Russian>";"<Polish>"...
"us_m41_walker_bulldog_shop";"M41A1";"M41A1";"M41A1 Walker Bulldog";"M41A1";"M41A1";"M41A1";"M41A1"...
"shop/group/he_112_group";"He 112";"He 112";"He 112";"He 112";"He 112";"He 112";"He 112"...
"cn_t_62_0";"Т-62 №545";"Т-62 №545";"Т-62 N°545";"Т-62 №545";"Т-62 N°545";"Т-62 №545";"Т-62 nr 545"...
```

### Формат файла wpcost.blkx (NEW)
```json
{
  "economicRankMax": 39,
  "fokker_d7": {
    "value": 700,
    "reqExp": 2900,
    "economicRankHistorical": 15,
    "repairTimeHrsArcade": 111.21,
    "repairCostArcade": 1976,
    "avgAwardArcade": 3965,
    ...
  },
  "a_10c": {
    "value": 950000,
    "reqExp": 350000,
    "economicRankHistorical": 32,
    ...
  }
}
```

## Алгоритм работы

### 1. Инициализация (main.py)
- Обработка аргументов командной строки
- Проверка существования конфигурационного файла
- Выбор режима работы (полный/только shop/только локализация/только wpcost)
- Создание экземпляров парсеров
- Обработка ошибок и прерываний

### 2. Настройка компонентов (utils.py)
- Чтение конфигурационного файла через класс `Config`
- Настройка логирования через класс `Logger`
- Загрузка констант из класса `Constants`

### 3. Предварительная очистка данных (shop_parser.py)

#### Система очистки от аномальных элементов
**Выполняется ПЕРЕД началом парсинга:**

**Аномальные окончания** (из `Constants.ANOMALOUS_SUFFIXES`):
- `_race` - гоночные события
- `_football` - футбольные события  
- `_yt_cup_2019` - YouTube Cup события
- `_event` - различные события

**Логика удаления "с корнем":**
- **Обычный элемент** с аномальным окончанием → удаляется
- **Группа содержит** аномальные элементы → удаляется вся группа
- **Сама группа** имеет аномальное окончание → удаляется со всем содержимым

**Детальное логирование очистки:**
- Количество удаленных элементов
- Подробный список с полными путями
- Причины удаления (аномальное окончание/группа с аномальными элементами)

### 4. Парсинг shop.blkx (shop_parser.py)
#### Сбор master-slave пар
**Выполняется ПОСЛЕ очистки данных:**
- Поиск элементов с полем `slaveUnit`
- Создание словаря пар `master_id -> slave_id`
- Формирование списка slave-юнитов для пропуска

#### Определение премиумных колонок
**Критерии премиумности:**
- Процент премиумной техники ≥ 30% (настраивается в `Constants.PREMIUM_THRESHOLD`)
- **Признаки премиумной техники** (из `Constants.PREMIUM_INDICATORS`):
  - `showOnlyWhenBought`
  - `gift`
  - `marketplaceItemdefId`
  - `isClanVehicle`
  - `showOnlyWhenResearch`
  - `event`
  - `hideFeature`
  - `beginPurchaseDate`/`endPurchaseDate`
  - `hideByPlatform`

#### Обработка зависимостей (предшественников)
**Правила определения предшественников:**

**Для обычной техники:**
- Если `reqAir` отсутствует или `reqAir != ""` → есть зависимость
- Если `reqAir = ""` → нет предшественника
- **Логика:**
  - Обычная техника зависит от предыдущего элемента
  - Первый элемент группы зависит от самой группы
  - Остальные элементы группы зависят от предыдущего элемента в группе
  - Техника после группы зависит от группы

**Для премиумной техники:**
- **Все предшественники = пустая строка** (независимо от `reqAir`)

#### Обработка групп
**Определение группы:**
- Название заканчивается на `_group` ИЛИ
- Содержит поле `image` ИЛИ
- Содержит вложенные элементы (не служебные поля из `Constants.SERVICE_FIELDS`)

**Обработка координат групп:**
- **Обычная техника:** координаты из `rankPosXY` или вычисляются
- **Премиумная техника:** элементы группы наследуют координаты группы

#### Обработка координат

**Обычная техника:**
```
column_index = номер столбца в JSON
row_index = rank - 1 (или из rankPosXY)
```

**Премиумная техника:**
```
column_index = 0, 1, 2... (счетчик премиум колонок)
row_index = группировка по рангам, внутри ранга: 0, 1, 2...
```

**Группировка премиум техники по рангам:**
- Ранг 1: row_index 0, 1, 2...
- Ранг 2: row_index 0, 1, 2...
- Ранг 3: row_index 0, 1, 2...

#### Master-slave обработка
- **Master-юниты** (например, `germ_iris_slm_fcs`) обрабатываются как обычная техника
- **Slave-юниты** (например, `germ_iris_slm_launcher`) пропускаются
- **Настройка:** `Constants.PROCESS_SLAVE_UNITS = False` (для будущего развития)

### 5. Парсинг локализации (localization_parser.py)

#### Загрузка и парсинг CSV локализации
**Приоритетная система обработки:**
- **Приоритет 1 (высший):** Записи с суффиксом `_shop` и `shop/group/`
- **Приоритет 10 (низкий):** Записи с числовыми суффиксами (`_0`, `_1`, `_2`)

**Алгоритм приоритетов:**
- При конфликте ключей выбирается запись с наивысшим приоритетом
- `ussr_zsu_37_2_shop` → ключ `ussr_zsu_37_2`, приоритет 1
- `ussr_zsu_37_2` → ключ `ussr_zsu_37_2`, приоритет 10
- Сохраняется значение из `_shop` записи

#### Типы обрабатываемых записей
1. **Записи с `_shop` суффиксом:**
   - `unit_name_shop` → ключ `unit_name`
   - Основная локализация для магазина

2. **Групповые записи:**
   - `shop/group/group_name` → ключ `group_name`
   - Локализация для папок/групп техники

3. **Записи с числовыми суффиксами:**
   - `unit_name_0`, `unit_name_1`, etc. → ключ `unit_name_0`, `unit_name_1`
   - Дополнительные варианты локализации

#### Стратегии поиска локализации
**Для каждого ID из shop.csv выполняется поиск в следующем порядке:**

1. **Прямой поиск точного совпадения**
   - Ищет `unit_id` в словаре локализации

2. **Точные совпадения с приоритетными суффиксами**
   - `unit_id + '_shop'` (приоритет 1)
   - `unit_id + '_1'` (приоритет 2)

3. **Поиск точных совпадений с любыми числовыми суффиксами**
   - Ищет ключи вида `unit_id + '_' + цифра`
   - Сортировка по приоритету: `_shop` → `_0` → `_1` → `_2`...

4. **Специальная обработка групп**
   - Для ID заканчивающихся на `_group`
   - Поиск ключей типа `shop/group/unit_id`

5. **Fallback**
   - Если ничего не найдено, возвращает сам ID

### 6. Парсинг экономических данных (wpcost_parser.py) (NEW)

#### Загрузка данных с поддержкой fallback URL
**Автоматическое переключение между источниками:**
- **Основной URL:** из конфигурации (`wpcost_url`)
- **Fallback URL:** из конфигурации (`wpcost_fallback_urls`, через запятую)
- **Обработка ошибок:** автоматическое переключение при 403 (файл > 20 МБ) или других ошибках

**Последовательность попыток:**
1. jsdelivr CDN (быстрый, но лимит 20 МБ)
2. GitHub Raw (прямая ссылка)
3. Statically.io CDN
4. GitCDN.xyz
5. Другие указанные в конфигурации

#### Извлечение экономических параметров
**Обрабатываемые поля из wpcost.blkx:**
- `value` → `silver` (серебро)
- `reqExp` → `exp` (опыт)
- `economicRankHistorical` → `br` (боевой рейтинг)

#### Обработка данных с fallback значениями
**Правила обработки:**

**value (silver):**
- Если отсутствует или некорректный → `0`
- Иначе → целое число

**reqExp (exp):**
- Если отсутствует или некорректный → пустое поле
- Если равен `0` → пустое поле (специальное условие)
- Иначе → целое число

**economicRankHistorical (br):**
- Если отсутствует или некорректный → `1.0` (fallback)
- Если равен `0` или отрицательный → `1.0` (fallback)
- Иначе → вычисляется по формуле

#### Вычисление боевого рейтинга (БР)
**Формула:** `БР = (economicRankHistorical / 3) + 1`

**Алгоритм округления:**
- Вычисляется "сырое" значение БР
- Определяются возможные значения: `X.0`, `X.3`, `X.7`, `(X+1).0`
- Выбирается ближайшее значение по расстоянию
- **Fallback:** если вычисление невозможно → `1.0`

**Примеры вычислений:**
```
economicRankHistorical = 32
БР_сырое = (32 / 3) + 1 = 11.67
Возможные: 11.0, 11.3, 11.7, 12.0
Ближайшее: 11.7

economicRankHistorical = 15
БР_сырое = (15 / 3) + 1 = 6.0
Результат: 6.0

economicRankHistorical = null
Результат: 1.0 (fallback)
```

#### Сопоставление с данными shop.csv
- Загружаются все ID из `shop.csv`
- Для каждого ID ищется соответствие в wpcost.blkx
- Если ID не найден → пропускается (не записывается в результат)
- Если ID найден → обрабатывается и записывается

## Выходные данные

### Формат shop.csv
```csv
id,rank,country,vehicle_type,type,status,column_index,row_index,predecessor,order_in_folder
germ_pzkpfw_35t,1,germany,Наземная техника,vehicle,standard,0,0,,
germ_pzkpfw_38t_group,1,germany,Наземная техника,folder,standard,0,0,germ_pzkpfw_35t,
germ_pzkpfw_38t_ausf_F,1,germany,Наземная техника,vehicle,standard,0,0,germ_pzkpfw_38t_group,0
```

### Формат localization.csv
```csv
id,localized_name
us_m41_walker_bulldog,M41A1
ussr_zsu_37_2,ЗСУ-37-2
he_112_group,He 112
cn_t_62,Т-62 №545
```

### Формат wpcost.csv (NEW)
```csv
id,silver,exp,br
a_10c,950000,350000,11.7
f4d_1,520000,190000,9.0
fokker_d7,700,2900,6.0
unit_without_data,0,,1.0
premium_unit,0,,5.3
```

### Описание полей shop.csv (из Constants.CSV_FIELDNAMES):
- **id:** Уникальный идентификатор техники
- **rank:** Ранг техники (1-8)
- **country:** Страна (germany, usa, ussr, etc.)
- **vehicle_type:** Тип техники (Наземная техника, Авиация, etc.)
- **type:** vehicle или folder
- **status:** standard или premium
- **column_index:** Номер колонки (для премиум техники: 0, 1, 2...)
- **row_index:** Позиция в колонке
- **predecessor:** ID предшественника (пусто для премиум техники)
- **order_in_folder:** Порядок в группе (0, 1, 2... или пусто)

### Описание полей localization.csv (из Constants.LOCALIZATION_CSV_FIELDNAMES):
- **id:** Уникальный идентификатор техники (совпадает с shop.csv)
- **localized_name:** Русское название техники

### Описание полей wpcost.csv (из Constants.WPCOST_CSV_FIELDNAMES) (NEW):
- **id:** Уникальный идентификатор техники (подмножество shop.csv)
- **silver:** Стоимость покупки в серебре (0 если данных нет)
- **exp:** Требуемый опыт для исследования (пусто если 0 или данных нет)
- **br:** Боевой рейтинг (вычисленный или 1.0 fallback)

## Конфигурация

### config.txt (ОБНОВЛЕНО)
```
shop_url=https://cdn.jsdelivr.net/gh/gszabi99/War-Thunder-Datamine@master/char.vromfs.bin_u/config/shop.blkx

localization_url=https://cdn.jsdelivr.net/gh/gszabi99/War-Thunder-Datamine@master/lang.vromfs.bin_u/lang/units.csv

# Основной URL для wpcost (jsdelivr ограничен 20 МБ)
wpcost_url=https://cdn.jsdelivr.net/gh/gszabi99/War-Thunder-Datamine@master/char.vromfs.bin_u/config/wpcost.blkx

# Fallback URL для больших файлов (через запятую)
wpcost_fallback_urls=https://github.com/gszabi99/War-Thunder-Datamine/raw/master/char.vromfs.bin_u/config/wpcost.blkx,https://cdn.statically.io/gh/gszabi99/War-Thunder-Datamine/master/char.vromfs.bin_u/config/wpcost.blkx,https://gitcdn.xyz/repo/gszabi99/War-Thunder-Datamine/master/char.vromfs.bin_u/config/wpcost.blkx

debug_mode=true
save_intermediate_files=true
```

### Настройки в Constants
- `PREMIUM_THRESHOLD = 0.3` - порог определения премиум колонки (30%)
- `PROCESS_SLAVE_UNITS = False` - обрабатывать ли slave-юниты
- `ANOMALOUS_SUFFIXES = ['_race', '_football', '_yt_cup_2019', '_event']` - аномальные окончания
- `WPCOST_CSV_FIELDNAMES = ['id', 'silver', 'exp', 'br']` - поля для CSV wpcost (NEW)

## Логирование

### Конфигурация логирования (Logger класс)
- **shop_parser_debug.log** - полная отладочная информация парсера shop.blkx (DEBUG уровень)
- **localization_parser_debug.log** - полная отладочная информация парсера локализации (DEBUG уровень)
- **wpcost_parser_debug.log** - полная отладочная информация парсера wpcost (DEBUG уровень) (NEW)
- **Консоль** - основные этапы работы (INFO уровень)

### Уровни логирования
- **INFO:** Основные этапы (очистка, загрузка, обработка стран, сохранение)
- **DEBUG:** Детальная информация о каждом элементе, очистке, поиске локализации и вычислении БР
- **WARNING:** Проблемы с данными, переключение между URL
- **ERROR:** Критические ошибки

### Примеры логов wpcost парсера (NEW)
```
Попытка 1: Загрузка данных wpcost из: https://cdn.jsdelivr.net/gh/.../wpcost.blkx
Получен код 403 (файл слишком большой или доступ запрещен) для URL...
Пробуем следующий URL...
Попытка 2: Загрузка данных wpcost из: https://github.com/.../wpcost.blkx
Размер файла: 25.3 МБ
Данные wpcost успешно загружены с попытки 2
БР расчет: economicRank=32, raw=11.667, округлено=11.7
БР расчет: economicRank некорректен (None), используем fallback 1.0
```

## Статистика выполнения

### По shop.blkx парсеру:
- Количество удаленных аномальных элементов
- Общее количество обработанных элементов
- Количество стандартной и премиумной техники
- Количество найденных master-slave пар
- Количество пропущенных slave-юнитов

### По парсеру локализации:
- Количество обработанных строк из CSV
- Количество найденных локализаций
- Количество fallback (не найденных) записей
- Статистика по приоритетам

### По парсеру wpcost (NEW):
- Количество ID из shop.csv
- Количество найденных в wpcost.blkx
- Количество пропущенных (не найденных)
- Количество записей с опытом
- Количество записей с fallback БР (1.0)
- Информация о попытках загрузки и использованных URL

## Обработка ошибок

### На уровне main.py:
- Проверка существования конфигурационного файла
- Обработка прерывания пользователем (Ctrl+C)
- Вывод пользовательских сообщений об ошибках
- Graceful обработка ошибок локализации и wpcost (продолжение работы без них)

### На уровне компонентов:
- **Config:** валидация конфигурационного файла
- **ShopParser:** проверка структуры данных, graceful handling сетевых ошибок, защита от аномальных элементов
- **LocalizationParser:** обработка некорректных CSV строк, приоритетное разрешение конфликтов
- **WpcostParser:** автоматическое переключение между URL, обработка больших файлов, fallback для некорректных данных (NEW)
- **Logger:** логирование предупреждений для некорректных элементов

## Требования к окружению

- **Python 3.7+**
- **Стандартные библиотеки:** json, csv, logging, typing, sys, os
- **Внешние библиотеки:** requests
- **Файлы:** 
  - config.txt с корректными URL (shop_url, localization_url, wpcost_url, wpcost_fallback_urls)
  - shop.csv (для работы только парсеров локализации и wpcost)

## Использование

### Полный парсинг (shop + локализация + wpcost) (ОБНОВЛЕНО)
```bash
python main.py
python main.py --config my_config.txt
```

### Только парсинг shop.blkx
```bash
python main.py --shop-only
python main.py --config my_config.txt --shop-only
```

### Только парсинг локализации
```bash
python main.py --localization-only
python main.py --config my_config.txt --localization-only
```

### Только парсинг wpcost (NEW)
```bash
python main.py --wpcost-only
python main.py --config my_config.txt --wpcost-only
```

### Справка (ОБНОВЛЕНО)
```bash
python main.py --help
```

### Результат выполнения (ОБНОВЛЕНО):
- **shop.csv** - основные данные техники (очищенные от аномальных элементов)
- **localization.csv** - маппинг ID → русские названия
- **wpcost.csv** - экономические данные (серебро, опыт, БР) (NEW)
- **shop_parser_debug.log** - подробный лог парсера shop.blkx с информацией об очистке
- **localization_parser_debug.log** - подробный лог парсера локализации
- **wpcost_parser_debug.log** - подробный лог парсера wpcost с информацией о вычислениях БР (NEW)
- Статистика в консоли включая информацию об удаленных элементах и экономических данных

## Расширяемость архитектуры

### Добавление новых типов аномальных элементов:
1. Добавить новые окончания в `Constants.ANOMALOUS_SUFFIXES`
2. При необходимости расширить логику в `has_anomalous_suffix()`

### Добавление новых форматов экспорта:
1. Создать новый метод в соответствующем парсере (например, `save_to_json()`)
2. Добавить константы в `Constants` при необходимости

### Добавление новых источников данных:
1. Расширить методы `fetch_*_data()` в соответствующих парсерах
2. Добавить новые URL в конфигурацию
3. Реализовать поддержку fallback URL по образцу wpcost парсера

### Добавление новых языков локализации:
1. Изменить индекс колонки в `parse_localization_csv()`
2. Добавить параметр языка в конфигурацию

### Добавление новых экономических параметров (NEW):
1. Расширить метод `extract_unit_data()` в `WpcostParser`
2. Добавить новые поля в `Constants.WPCOST_CSV_FIELDNAMES`
3. Обновить алгоритмы обработки данных

### Добавление новых типов логирования:
1. Расширить класс `Logger` в `utils.py`
2. Добавить новые обработчики логов

### Интеграция с базами данных:
1. Создать новый модуль `database_manager.py`
2. Объединить данные из shop.csv, localization.csv и wpcost.csv
3. Добавить методы для работы с различными СУБД

### Улучшение системы обработки больших файлов (NEW):
1. Добавить поддержку streaming загрузки для файлов > 100 МБ
2. Реализовать кеширование больших файлов локально
3. Добавить поддержку сжатых форматов (gzip, brotli)

### Улучшение системы вычисления БР (NEW):
1. Добавить поддержку альтернативных формул БР для разных типов техники
2. Реализовать валидацию вычисленных значений БР
3. Добавить поддержку исторических изменений формул БР

### Улучшение системы fallback URL (NEW):
1. Добавить автоматическое определение зеркал репозитория
2. Реализовать проверку доступности URL перед использованием
3. Добавить кеширование информации о работоспособности URL

## Технические особенности новой версии

### Обработка больших файлов:
- **Автоматическое переключение** между CDN при ошибках 403
- **Поддержка файлов > 20 МБ** через fallback URL
- **Увеличенный timeout** для загрузки больших файлов (45 сек)
- **Мониторинг размера файла** с выводом в логи

### Улучшенная обработка данных:
- **Fallback значения** для всех критических параметров
- **Умная валидация** входных данных с типизацией
- **Специальная логика** для обработки нулевых значений опыта
- **Гарантированные числовые БР** (минимум 1.0)

### Расширенная статистика:
- **Детальная информация** о попытках загрузки
- **Статистика по fallback значениям** 
- **Мониторинг качества данных** (процент успешных вычислений)
- **Информация об использованных URL** и CDN

## Архитектурные принципы

### Модульность:
- Каждый парсер - отдельный самодостаточный модуль
- Общие компоненты вынесены в utils.py
- Возможность запуска любого парсера независимо

### Отказоустойчивость:
- Graceful handling всех типов ошибок
- Автоматическое переключение между источниками данных
- Fallback значения для критически важных параметров
- Продолжение работы при недоступности отдельных модулей

### Масштабируемость:
- Легкое добавление новых парсеров по образцу существующих
- Конфигурируемые параметры через файл настроек
- Расширяемая система констант и маппингов
- Поддержка различных форматов входных и выходных данных

### Наблюдаемость:
- Подробное логирование всех операций
- Статистика выполнения для каждого модуля
- Отладочная информация для диагностики проблем
- Мониторинг производительности и качества данных

Модульная архитектура с интегрированными системами очистки, локализации и экономических данных обеспечивает комплексную обработку информации War Thunder, стабильную работу с любыми входными данными, автоматическое переключение между источниками при проблемах с доступностью, легкую поддержку и развитие проекта без нарушения существующей функциональности. Система приоритетов в парсере локализации гарантирует корректную обработку сложных случаев с конфликтующими записями, предварительная очистка защищает от проблемных элементов, а парсер экономических данных обеспечивает надежное извлечение критически важной игровой информации с автоматическим вычислением боевых рейтингов.